@model IEnumerable<EduSubmit.Models.Grade>

@{
    ViewData["Title"] = "Grades";
    ViewData["ActivePage"] = "Grades";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";

    var subjects = Model.Select(g => g.Assignment?.SubjectName).Distinct().Where(s => s != null).ToList();
    var isCodingAssignments = ViewBag.IsCodingAssignments as Dictionary<int, bool> ?? new Dictionary<int, bool>();
}

<div class="container mt-4">
    <div class="card border border-primary shadow-sm mb-3">
        <div class="card-body text-center">
            <h2 class="text-primary">📊 Grades</h2>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex">
            <label class="me-2 fw-bold align-self-center">Filter by Subject:</label>
            <select class="form-select me-2" id="subjectDropdown">
                <option value="">All Subjects</option>
                @foreach (var subject in subjects) {
                    <option value="@subject">@subject</option>
                }
            </select>
        </div>

        <div class="d-flex">
            <label class="me-2 fw-bold align-self-center">Filter by Type:</label>
            <select class="form-select" id="typeDropdown">
                <option value="">All Assignments</option>
                <option value="coding">Coding Assignments</option>
                <option value="normal">Normal Assignments</option>
            </select>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-striped table-hover text-center" id="gradesTable">
                <thead class="text-white" style="background: linear-gradient(135deg, #007BFF, #0056b3);">
                    <tr>
                        <th id="assignmentColumn" class="sortable" data-sort="assignment">Assignment 🔼</th>
                        <th>Subject</th>
                        <th id="scoreColumn" class="sortable" data-sort="score">Score 🔼</th>
                        <th id="maxScoreColumn" class="sortable" data-sort="maxScore">Max Score 🔼</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gradesBody">
                    @foreach (var grade in Model) {
                        bool isCoding = isCodingAssignments.TryGetValue(grade.AssignmentId, out bool coding) && coding;
                        <tr data-subject="@grade.Assignment?.SubjectName" data-type="@(isCoding ? "coding" : "normal")">
                            <td class="assignment">@grade.Assignment?.Title</td>
                            <td>@grade.Assignment?.SubjectName</td>
                            <td class="score">@grade.Score</td>
                            <td class="maxScore">@grade.Assignment?.Points</td>
                            <td>@grade.Remarks</td>
                            <td>
                                <a asp-action="Details" asp-controller="Grade"
                                   asp-route-studentId="@grade.StudentId"
                                   asp-route-assignmentId="@grade.AssignmentId"
                                   class="btn btn-info btn-sm shadow-sm">
                                    📖 Details
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
        document.addEventListener("DOMContentLoaded", function () {
        const subjectDropdown = document.getElementById("subjectDropdown");
        const typeDropdown = document.getElementById("typeDropdown");
        const gradesBody = document.getElementById("gradesBody");
        const assignmentColumn = document.getElementById("assignmentColumn");
        const scoreColumn = document.getElementById("scoreColumn");
        const maxScoreColumn = document.getElementById("maxScoreColumn");
        let sortOrder = { assignment: true, score: true, maxScore: true };

        function filterTable() {
            const selectedSubject = subjectDropdown.value.toLowerCase();
            const selectedType = typeDropdown.value.toLowerCase();

            document.querySelectorAll("#gradesBody tr").forEach(row => {
                const rowSubject = row.getAttribute("data-subject")?.toLowerCase() || "";
                const rowType = row.getAttribute("data-type")?.toLowerCase() || "";

                const subjectMatch = !selectedSubject || rowSubject === selectedSubject;
                const typeMatch = !selectedType || rowType === selectedType;

                row.style.display = subjectMatch && typeMatch ? "" : "none";
            });
        }

        function sortTable(column, key) {
            let rows = Array.from(gradesBody.querySelectorAll("tr"));
            rows.sort((a, b) => {
                let valA = key === "assignment"
                    ? a.querySelector("." + key).textContent.trim().toLowerCase()
                    : parseFloat(a.querySelector("." + key).textContent) || 0;
                let valB = key === "assignment"
                    ? b.querySelector("." + key).textContent.trim().toLowerCase()
                    : parseFloat(b.querySelector("." + key).textContent) || 0;

                return sortOrder[key] ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });

            rows.forEach(row => gradesBody.appendChild(row));
            sortOrder[key] = !sortOrder[key];
            column.innerHTML = `${column.textContent.replace(/[🔼🔽]/g, '')} ${sortOrder[key] ? "🔼" : "🔽"}`;
        }

        subjectDropdown.addEventListener("change", filterTable);
        typeDropdown.addEventListener("change", filterTable);
        assignmentColumn.addEventListener("click", () => sortTable(assignmentColumn, "assignment"));
        scoreColumn.addEventListener("click", () => sortTable(scoreColumn, "score"));
        maxScoreColumn.addEventListener("click", () => sortTable(maxScoreColumn, "maxScore"));
    });
</script>